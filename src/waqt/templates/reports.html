{% extends "base.html" %}

{% block title %}Reports - Waqt{% endblock %}

{% block content %}
<div class="reports-page" data-testid="reports-page">
    <h2>Reports</h2>
    
    <div class="report-controls">
        <div class="period-selector" data-testid="period-selector">
            <a href="{{ url_for('main.reports', period='week', date=selected_date.isoformat()) }}" 
               class="btn {% if period == 'week' %}btn-primary{% else %}btn-secondary{% endif %}" data-testid="btn-week-view">
                Week View
            </a>
            <a href="{{ url_for('main.reports', period='month', date=selected_date.isoformat()) }}" 
               class="btn {% if period == 'month' %}btn-primary{% else %}btn-secondary{% endif %}" data-testid="btn-month-view">
                Month View
            </a>
        </div>
        
        <div class="export-controls" style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('main.export_csv', period=period, date=selected_date.isoformat()) }}" 
               class="btn btn-success" 
               title="Export to CSV">
                CSV
            </a>
            <a href="{{ url_for('main.export_json', period=period, date=selected_date.isoformat()) }}" 
               class="btn btn-secondary" 
               title="Export to JSON">
                JSON
            </a>
            <a href="{{ url_for('main.export_excel', period=period, date=selected_date.isoformat()) }}" 
               class="btn btn-secondary" 
               title="Export to Excel">
                Excel
            </a>
        </div>
        
        <div class="date-navigator" data-testid="date-navigator">
            {% if period == 'week' %}
                {% set prev_date = (start_date - timedelta(days=7)).isoformat() %}
                {% set next_date = (start_date + timedelta(days=7)).isoformat() %}
            {% else %}
                {% set prev_date = (start_date - timedelta(days=28)).replace(day=1).isoformat() %}
                {% set next_month = start_date.month + 1 if start_date.month < 12 else 1 %}
                {% set next_year = start_date.year if start_date.month < 12 else start_date.year + 1 %}
                {% set next_date = start_date.replace(month=next_month, year=next_year, day=1).isoformat() %}
            {% endif %}
            
            <a href="{{ url_for('main.reports', period=period, date=prev_date) }}" class="btn btn-secondary" data-testid="btn-prev-period">← Previous</a>
            <span class="current-period" data-testid="current-period">
                {% if period == 'week' %}
                    {{ start_date.strftime('%b %d') }} - {{ end_date.strftime('%b %d, %Y') }}
                {% else %}
                    {{ start_date.strftime('%B %Y') }}
                {% endif %}
            </span>
            <a href="{{ url_for('main.reports', period=period, date=next_date) }}" class="btn btn-secondary" data-testid="btn-next-period">Next →</a>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card" data-testid="stat-total-hours">
            <h3>Total Hours</h3>
            <div class="stat-number">{{ stats.total_hours }}h</div>
            <p class="stat-label">Worked</p>
        </div>
        
        <div class="stat-card" data-testid="stat-overtime">
            <h3>Overtime</h3>
            <div class="stat-number {% if stats.overtime > 0 %}text-warning{% endif %}">
                {{ stats.overtime }}h
            </div>
            <p class="stat-label">Over Standard</p>
        </div>
        
        <div class="stat-card" data-testid="stat-working-days">
            <h3>Working Days</h3>
            <div class="stat-number">{{ stats.working_days }}</div>
            <p class="stat-label">Days Worked</p>
        </div>
        
        {% if period == 'month' %}
        <div class="stat-card" data-testid="stat-leave-days">
            <h3>Leave Days</h3>
            <div class="stat-number">{{ stats.vacation_days + stats.sick_days }}</div>
            <p class="stat-label">{{ stats.vacation_days }} vacation, {{ stats.sick_days }} sick</p>
        </div>
        {% endif %}
    </div>
    
    {% if entries %}
        <div class="section">
            <h3>Category Breakdown</h3>
            <div class="category-grid">
                {% for name, data in category_stats.items() %}
                <div class="stat-card category-card" style="--category-color: {{ data.color }};">
                    <h4>{{ name }}</h4>
                    <div class="stat-number">{{ "%.2f"|format(data.hours) }}h</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="section">
            <h3>Time Entries</h3>
            <table class="data-table" data-testid="entries-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Time</th>
                        <th>Duration</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entries %}
                    <tr>
                        <td>{{ entry.date.strftime('%Y-%m-%d (%a)') }}</td>
                        <td>
                            {% if entry.category %}
                            <span class="badge" style="background-color: {{ entry.category.color }}; color: rgba(0, 0, 0, 0.85); text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);">{{ entry.category.name }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ entry.start_time|format_time }} - {{ entry.end_time|format_time }}</td>
                        <td>{{ "%.2f"|format(entry.duration_hours) }}h</td>
                        <td>{{ entry.description }}</td>
                        <td>
                            <a href="{{ url_for('main.edit_time_entry', entry_id=entry.id) }}" class="btn btn-primary btn-small" data-testid="btn-edit-entry-{{ entry.id }}">Edit</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h3>Daily Summary</h3>
            <table class="data-table" data-testid="daily-summary-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Total Hours</th>
                        <th>Overtime</th>
                    </tr>
                </thead>
                <tbody>
                    {% for date_key, day_entries in entries_by_date.items() %}
                        {% set daily_total = day_entries|sum(attribute='duration_hours') %}
                        {% set daily_overtime = [0, daily_total - 8]|max %}
                    <tr>
                        <td>{{ day_entries[0].date.strftime('%Y-%m-%d (%a)') }}</td>
                        <td>{{ "%.2f"|format(daily_total) }}h</td>
                        <td class="{% if daily_overtime > 0 %}text-warning{% endif %}">
                            {{ "%.2f"|format(daily_overtime) }}h
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state" data-testid="empty-entries">
            <p>No time entries found for this period.</p>
            <a href="{{ url_for('main.time_entry') }}" class="btn btn-primary">Add Time Entry</a>
        </div>
    {% endif %}
    
    {% if leave_days %}
        <div class="section">
            <h3>Leave Days</h3>
            <table class="data-table" data-testid="leave-days-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in leave_days %}
                    <tr>
                        <td>{{ leave.date.strftime('%Y-%m-%d (%a)') }}</td>
                        <td><span class="badge badge-{{ leave.leave_type }}">{{ leave.leave_type|capitalize }}</span></td>
                        <td>{{ leave.description or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</div>
{% endblock %}
